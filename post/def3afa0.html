<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>用OSM的AOI裁剪影像的Python自动化方法 | Siang的博客</title><meta name="description" content="本文介绍获取OSM的AOI，并下载对应影像进行AOI区域裁剪的方法。"><meta name="keywords" content="遥感,数据处理,AOI,OSM"><meta name="author" content="Siang"><meta name="copyright" content="Siang"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="用OSM的AOI裁剪影像的Python自动化方法"><meta name="twitter:description" content="本文介绍获取OSM的AOI，并下载对应影像进行AOI区域裁剪的方法。"><meta name="twitter:image" content="https://i.loli.net/2020/05/24/wz4Fho9QcKuSiqI.jpg"><meta property="og:type" content="article"><meta property="og:title" content="用OSM的AOI裁剪影像的Python自动化方法"><meta property="og:url" content="https://psiang.github.io/post/def3afa0.html"><meta property="og:site_name" content="Siang的博客"><meta property="og:description" content="本文介绍获取OSM的AOI，并下载对应影像进行AOI区域裁剪的方法。"><meta property="og:image" content="https://i.loli.net/2020/05/24/wz4Fho9QcKuSiqI.jpg"><meta property="article:published_time" content="2020-07-02T16:05:10.000Z"><meta property="article:modified_time" content="2020-07-03T16:28:10.126Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://psiang.github.io/post/def3afa0.html"><link rel="next" title="新深度卷积网络一览（二）" href="https://psiang.github.io/post/6682fb6a.html"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">3</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">7</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#从osm获取aoi"><span class="toc-number">1.</span> <span class="toc-text"> 从OSM获取AOI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#aoi的获取"><span class="toc-number">1.1.</span> <span class="toc-text"> AOI的获取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#以城市名限定范围"><span class="toc-number">1.1.1.</span> <span class="toc-text"> 以城市名限定范围</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#以矩形限定范围"><span class="toc-number">1.1.2.</span> <span class="toc-text"> 以矩形限定范围</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#aoi的保存"><span class="toc-number">1.2.</span> <span class="toc-text"> AOI的保存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取aoi结果展示"><span class="toc-number">1.3.</span> <span class="toc-text"> 获取AOI结果展示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取aoi对应遥感影像"><span class="toc-number">2.</span> <span class="toc-text"> 获取AOI对应遥感影像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#求最小外包围矩形"><span class="toc-number">2.1.</span> <span class="toc-text"> 求最小外包围矩形</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#将矩形坐标转化为瓦片坐标"><span class="toc-number">2.2.</span> <span class="toc-text"> 将矩形坐标转化为瓦片坐标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取瓦片"><span class="toc-number">2.3.</span> <span class="toc-text"> 获取瓦片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#拼接瓦片为影像"><span class="toc-number">2.4.</span> <span class="toc-text"> 拼接瓦片为影像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#导出影像及其信息"><span class="toc-number">2.5.</span> <span class="toc-text"> 导出影像及其信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取影像及其信息展示"><span class="toc-number">2.6.</span> <span class="toc-text"> 获取影像及其信息展示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#按照aoi范围裁剪影像"><span class="toc-number">3.</span> <span class="toc-text"> 按照AOI范围裁剪影像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#经纬坐标到像素坐标的转换"><span class="toc-number">3.1.</span> <span class="toc-text"> 经纬坐标到像素坐标的转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#裁剪影像"><span class="toc-number">3.2.</span> <span class="toc-text"> 裁剪影像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#裁剪结果展示"><span class="toc-number">3.3.</span> <span class="toc-text"> 裁剪结果展示</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://i.loli.net/2020/05/24/wz4Fho9QcKuSiqI.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Siang的博客</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">用OSM的AOI裁剪影像的Python自动化方法</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-07-03 00:05:10"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-07-03</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-07-04 00:28:10"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-07-04</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E9%81%A5%E6%84%9F/">遥感</a><i class="fa fa-angle-right post-meta__separator" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E9%81%A5%E6%84%9F/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/">数据处理</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p>OSM（OpenStreetMap）是一个开放的，用户可编辑的世界地图。AOI（Area of Interst）为兴趣面，包含以个区域内的如名称，土地用途等各种信息，在实际应用中我们常常希望得到以AOI划分的要偶感影像。本文将介绍获取OSM的AOI，并进一步获取到AOI区域遥感影像的方法。本文将步骤大致分为获取AOI、获取影像、裁剪影像三步。</p>
<p>代码可以参考项目：<a href="https://github.com/psiang/OSMcrop" target="_blank" rel="noopener">https://github.com/psiang/OSMcrop</a></p>
<h2 id="从osm获取aoi"><a class="markdownIt-Anchor" href="#从osm获取aoi"></a> 从OSM获取AOI</h2>
<p>获取方式是使用<a href="https://wiki.openstreetmap.org/wiki/Overpass_API" target="_blank" rel="noopener">Overpass</a>的API，官网上给了不少<a href="https://wiki.openstreetmap.org/wiki/Overpass_API/Overpass_API_by_Example" target="_blank" rel="noopener">示例</a>来参考。在Python中，主要调用方法如下，其中query是请求查询的指令，有特定的格式，可在官网查看参考：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> overpy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取OverPass类</span></span><br><span class="line">osm_op_api = overpy.Overpass()</span><br><span class="line"><span class="comment"># 调用类中的接口</span></span><br><span class="line">result = osm_op_api.query(query)</span><br></pre></td></tr></table></figure>
<p>即将指令发送给服务器返回查询结果。这个接口调用频率不能过快，且一次获取的Node数目有一定限制。</p>
<h3 id="aoi的获取"><a class="markdownIt-Anchor" href="#aoi的获取"></a> AOI的获取</h3>
<p>从OSM可以获取到三种<a href="https://wiki.openstreetmap.org/wiki/Elements" target="_blank" rel="noopener">元素</a>——Node、Way和Relation。我们要得到的AOI属于一种Way，但这个Way需要符合需求。每个元素都有自己的Feature在tags标签下，可以在此基础上删选，例如只保留土地利用为住宅区的区域。更多的Feature可以看<a href="https://wiki.openstreetmap.org/wiki/Map_Features" target="_blank" rel="noopener">这里</a>。</p>
<p>根据官网示例，条件筛选query指令可以在中括号内用“=”后接一个确定的属性，或者“~”后接正则表达式：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[out:csv(number,length)][maxsize:<span class="number">1000000000</span>];</span><br><span class="line">[[:Template:GeocodeArea:Sweden]]-&gt;.searchArea;</span><br><span class="line">way[<span class="string">"highway"</span>=<span class="string">"path"</span>][<span class="string">"foot"</span>!~<span class="string">".*"</span>][<span class="string">"bicycle"</span>!~<span class="string">".*"</span>][<span class="string">"segregated"</span>!~<span class="string">".*"</span>](area.searchArea);</span><br><span class="line">make stat number=count(ways),length=sum(length());</span><br><span class="line">out;</span><br></pre></td></tr></table></figure>
<p>要筛选土地利用中的住宅区可以改成：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">way[<span class="string">"landuse"</span>=<span class="string">"residential"</span>](area.searchArea);</span><br></pre></td></tr></table></figure>
<p>除了筛选Way的属性以外，还要对筛选的地理位置范围进行限制。本文提供以城市名限定范围和矩形限定范围的方式获取两个例子，供大家参考。其中在<a href="#%E4%BB%A5%E7%9F%A9%E5%BD%A2%E9%99%90%E5%AE%9A%E8%8C%83%E5%9B%B4">矩形限定范围</a>的例子中给出了<strong>解决接口访问频率和数目限制的方法</strong>。</p>
<h4 id="以城市名限定范围"><a class="markdownIt-Anchor" href="#以城市名限定范围"></a> 以城市名限定范围</h4>
<p>官网参考的城市名限定查询语句如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">area[name=<span class="string">"Česko"</span>];</span><br><span class="line">node[information=<span class="string">"guidepost"</span>](area);</span><br><span class="line">out;</span><br></pre></td></tr></table></figure>
<p>Way中的Nodes时用Node的ID表示的，而为了得到Way上每个结点的坐标，需要把Node也获取下来，将范围限制在获取的Way中：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">way[<span class="string">"landuse"</span>=<span class="string">"residential"</span>](area);</span><br><span class="line">node(w);</span><br></pre></td></tr></table></figure>
<p>假设要得到芬兰首都Helsinki中所有住宅区的AOI，结合对Way属性的筛选，我们可以如下构建请求语句的代码。其中key_kist是一个需求属性字典，name是城市名称。当一个关键字下有多个属性要对应时，使用了正则的方式“|”合并起来，否则直接用“=”即可。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># name = Helsinki</span></span><br><span class="line"><span class="comment"># key_list = &#123;"landuse":["residential"]&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">query = <span class="string">"[out:json];\n"</span></span><br><span class="line">query += <span class="string">"area[\"name\"=\"&#123;0&#125;\"]-&gt;.searchArea;\n"</span>.format(name)</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> key_list.keys():</span><br><span class="line">    query += <span class="string">"(\n"</span></span><br><span class="line">    temp = <span class="string">"\"&#123;0&#125;\""</span>.format(key)</span><br><span class="line">    <span class="keyword">if</span> len(key_list[key]) == <span class="number">1</span>:</span><br><span class="line">        temp += <span class="string">"=\"&#123;0&#125;\""</span>.format(key_list[key][<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        temp += <span class="string">"~\"&#123;0&#125;"</span>.format(key_list[key][<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">for</span> v <span class="keyword">in</span> range(<span class="number">1</span>, len(key_list[key])):</span><br><span class="line">            temp += <span class="string">"|&#123;0&#125;"</span>.format(key_list[key][v])</span><br><span class="line">        temp += <span class="string">"\""</span></span><br><span class="line">    query += <span class="string">"way[&#123;0&#125;](area.searchArea);\n"</span>.format(temp)</span><br><span class="line">    query += <span class="string">"node(w);\n"</span></span><br><span class="line">    query += <span class="string">");\n"</span></span><br><span class="line">query += <span class="string">"out;\n"</span></span><br><span class="line">osm_op_api = overpy.Overpass()</span><br><span class="line">result = osm_op_api.query(query)</span><br></pre></td></tr></table></figure>
<p>所生成的指令为：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[out:json];</span><br><span class="line">area["name"="Helsinki"]-&gt;.searchArea;</span><br><span class="line">(</span><br><span class="line">way[<span class="string">"landuse"</span>=<span class="string">"residential"</span>](area.searchArea);</span><br><span class="line">node(w);</span><br><span class="line">);</span><br><span class="line">out;</span><br></pre></td></tr></table></figure>
<h4 id="以矩形限定范围"><a class="markdownIt-Anchor" href="#以矩形限定范围"></a> 以矩形限定范围</h4>
<p>改成矩形只需要将指令中way的圆括号内换成南西北东的纬/经度就可以了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">way[<span class="string">"landuse"</span>=<span class="string">"residential"</span>](<span class="number">60.1162</span>,<span class="number">24.7522</span>,<span class="number">60.3041</span>,<span class="number">25.2466</span>);</span><br></pre></td></tr></table></figure>
<p>对于矩形限定范围，可以较好地解决接口次数和数目限制问题：</p>
<ol>
<li>
<p>为了解决调用频率太快的问题，一旦查询返回了OverpassTooManyRequests的异常则休眠一段时间重新查询。</p>
</li>
<li>
<p>为了解决返回结点数目限制地问题，一旦报错结点数目过多，则将当前的矩形范围分成更小的范围来查询，将获取的结果合并即可。这个划分可以分治地进行下去。</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">osm_request</span><span class="params">(lat1, lon1, lat2, lon2)</span>:</span></span><br><span class="line">    flag = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">while</span> flag:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 查询</span></span><br><span class="line">                query = (<span class="string">"[out:json];\n"</span></span><br><span class="line">                         <span class="string">"(\n"</span></span><br><span class="line">                         <span class="string">"way[\"landuse\"=\"residential\"](&#123;0&#125;,&#123;1&#125;,&#123;2&#125;,&#123;3&#125;);\n"</span></span><br><span class="line">                         <span class="string">"node(w);\n"</span></span><br><span class="line">                         <span class="string">");\n"</span></span><br><span class="line">                         <span class="string">"out;\n"</span>).format(lat1, lon1, lat2, lon2)</span><br><span class="line">                osm_op_api = overpy.Overpass()</span><br><span class="line">                result = osm_op_api.query(query)</span><br><span class="line">            <span class="keyword">except</span> ConnectionResetError <span class="keyword">as</span> e:</span><br><span class="line">                <span class="comment"># 划分成更小的范围</span></span><br><span class="line">                print(e)</span><br><span class="line">                result = overpy.Result()</span><br><span class="line">                dim = <span class="number">3</span>      <span class="comment"># 划分成3*3</span></span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> range(dim):</span><br><span class="line">                    <span class="keyword">for</span> j <span class="keyword">in</span> range(dim):</span><br><span class="line">                        temp = osm_request(lat1 + (lat2 - lat1) / dim * i,</span><br><span class="line">                                            lon1 + (lon2 - lon1) / dim * i,</span><br><span class="line">                                            lat1 + (lat2 - lat1) / dim * (i + <span class="number">1</span>),</span><br><span class="line">                                            lon1 + (lon2 - lon1) / dim * (i + <span class="number">1</span>))</span><br><span class="line">                        result.expand(temp)</span><br><span class="line">            flag = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> (Exception, overpy.exception.OverpassTooManyRequests) <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># 休眠一段时间重新查询</span></span><br><span class="line">            print(e)</span><br><span class="line">            time.sleep(<span class="number">60</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
<h3 id="aoi的保存"><a class="markdownIt-Anchor" href="#aoi的保存"></a> AOI的保存</h3>
<p>通过query返回得到的result如果需要获得Node和Way可以直接用以下方式得到：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result.nodes</span><br><span class="line">result.ways</span><br></pre></td></tr></table></figure>
<p>而Way的tag获取方式也类似，注意构成Way的Nodes的获取方式，如果是要id列表必须要越权。获取Node坐标的方式也很简单：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">way = result.ways[<span class="number">0</span>]</span><br><span class="line"><span class="comment"># 获取Way的feature</span></span><br><span class="line">tag = way.tags</span><br><span class="line"><span class="comment"># 获取Way的ID</span></span><br><span class="line">id = way.id</span><br><span class="line"><span class="comment"># 得到的是像result格式一样的Nodes</span></span><br><span class="line">nodes = tags.get_nodes()</span><br><span class="line"><span class="comment"># 得到的是组成Way的Nodes的ID列表</span></span><br><span class="line">node_id = tags._node_ids</span><br><span class="line"><span class="comment"># 获取Node的纬度和经度</span></span><br><span class="line">lat, lon = nodes[<span class="number">0</span>].lat, nodes[<span class="number">0</span>].lon</span><br></pre></td></tr></table></figure>
<p>下面以将AOI信息保留至CSV文件为例子。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">way2csv</span><span class="params">(way, key_list)</span>:</span></span><br><span class="line">    line = <span class="string">""</span></span><br><span class="line">    <span class="comment"># 只保留需要的信息</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> way.tags.keys():</span><br><span class="line">        <span class="keyword">if</span> k <span class="keyword">in</span> key_list.keys() <span class="keyword">and</span> way.tags[k] <span class="keyword">in</span> key_list[k]:</span><br><span class="line">            line += <span class="string">"%s, %s,%s"</span> % (way.id, k, way.tags[k])</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="comment"># 找Node的坐标记录下来，可提前将Node存入字典nodes_list方便查找</span></span><br><span class="line">    <span class="keyword">for</span> id <span class="keyword">in</span> way._node_ids:</span><br><span class="line">        <span class="keyword">if</span> id <span class="keyword">in</span> nodes_list:</span><br><span class="line">            line += <span class="string">",%s,%s"</span> % (nodes_list[id][<span class="number">0</span>], nodes_list[id][<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> line</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># AOI获取</span></span><br><span class="line">wayset = result.ways</span><br><span class="line">fway = open(<span class="string">"%s_aoi.csv"</span> % name, <span class="string">"w+"</span>)</span><br><span class="line"><span class="keyword">for</span> way <span class="keyword">in</span> wayset:</span><br><span class="line">    fway.write(way2csv(way, key_list) + <span class="string">"\n"</span>)</span><br><span class="line">fway.close()</span><br></pre></td></tr></table></figure>
<h3 id="获取aoi结果展示"><a class="markdownIt-Anchor" href="#获取aoi结果展示"></a> 获取AOI结果展示</h3>
<p><img src="/post/def3afa0/1.png" alt="AOI获取结果"></p>
<h2 id="获取aoi对应遥感影像"><a class="markdownIt-Anchor" href="#获取aoi对应遥感影像"></a> 获取AOI对应遥感影像</h2>
<p>参考自项目<a href="https://github.com/modyuan/getmap" target="_blank" rel="noopener">https://github.com/modyuan/getmap</a>以及博客<a href="https://www.cnblogs.com/modyuan/p/12293843.html" target="_blank" rel="noopener">https://www.cnblogs.com/modyuan/p/12293843.html</a>。</p>
<p>在上一步我们得到了每个AOI上的点的坐标，下面我们希望通过这些坐标获取到AOI对应的遥感影像。根据参考博客，思路可以是通过获取并合并瓦片得到，大致可以分为以下几步：</p>
<ol>
<li>求最小外包围矩形</li>
<li>将矩形坐标转换为瓦片坐标</li>
<li>获取瓦片</li>
<li>拼接瓦片为影像</li>
<li>导出影像及其信息</li>
</ol>
<h3 id="求最小外包围矩形"><a class="markdownIt-Anchor" href="#求最小外包围矩形"></a> 求最小外包围矩形</h3>
<p>直接遍历AOI的所有点的坐标，找到经纬度最大和最小的即可。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pos为从csv文件获取到的坐标串，以纬度1、经度1、纬度2、经度2……的顺序排列</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># find the bounder of polygon</span></span><br><span class="line">max_x = pos[<span class="number">1</span>]</span><br><span class="line">min_x = pos[<span class="number">1</span>]</span><br><span class="line">max_y = pos[<span class="number">0</span>]</span><br><span class="line">min_y = pos[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(pos), <span class="number">2</span>):</span><br><span class="line">    x = pos[i+<span class="number">1</span>]</span><br><span class="line">    y = pos[i]</span><br><span class="line">    max_x = max(max_x, x)</span><br><span class="line">    max_y = max(max_y, y)</span><br><span class="line">    min_x = min(min_x, x)</span><br><span class="line">    min_y = min(min_y, y)</span><br></pre></td></tr></table></figure>
<p>这样一来（max_x, min_y）是右下角，（min_x, max_y）是左上角。</p>
<h3 id="将矩形坐标转化为瓦片坐标"><a class="markdownIt-Anchor" href="#将矩形坐标转化为瓦片坐标"></a> 将矩形坐标转化为瓦片坐标</h3>
<p>互联网地图用墨卡托投影生成瓦片。墨卡托投影是地球放在一个圆柱内的投影。瓦片坐标系是将墨卡托投影地图的左上角作为瓦片坐标系原点，右方向为X轴，下方向Y轴。假设瓦片层级为level，瓦片的X轴和Y轴都被分成<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>2</mn><mrow><mi>l</mi><mi>e</mi><mi>v</mi><mi>e</mi><mi>l</mi></mrow></msup></mrow><annotation encoding="application/x-tex">2^{level}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.849108em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span></span></span></span></span></span></span></span>段，这样地图上的瓦片总数为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>2</mn><mrow><mi>l</mi><mi>e</mi><mi>v</mi><mi>e</mi><mi>l</mi></mrow></msup><mo>×</mo><msup><mn>2</mn><mrow><mi>l</mi><mi>e</mi><mi>v</mi><mi>e</mi><mi>l</mi></mrow></msup></mrow><annotation encoding="application/x-tex">2^{level}\times2^{level}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.932438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.849108em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.849108em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span></span></span></span></span></span></span></span>。更多细节可以参考<a href="http://cntchen.github.io/2016/05/09/%E5%9B%BD%E5%86%85%E4%B8%BB%E8%A6%81%E5%9C%B0%E5%9B%BE%E7%93%A6%E7%89%87%E5%9D%90%E6%A0%87%E7%B3%BB%E5%AE%9A%E4%B9%89%E5%8F%8A%E8%AE%A1%E7%AE%97%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">这里</a>。</p>
<p><img src="/post/def3afa0/2.png" alt="墨卡托投影"></p>
<p>假设已知WGS84经纬度<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>o</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">lon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>a</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">lat</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span></span></span></span>，需要的瓦片层级为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span></span></span></span>，则经纬度到瓦片的转换公式如下：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>=</mo><mo stretchy="false">⌊</mo><mfrac><mrow><mi>l</mi><mi>o</mi><mi>n</mi><mo>+</mo><mn>180</mn></mrow><mn>360</mn></mfrac><mo>×</mo><msup><mn>2</mn><mi>z</mi></msup><mo stretchy="false">⌋</mo></mrow><annotation encoding="application/x-tex">x=\lfloor \frac{lon+180}{360} \times 2^z \rfloor
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.05744em;vertical-align:-0.686em;"></span><span class="mopen">⌊</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span><span class="mord">6</span><span class="mord">0</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mord">8</span><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7143919999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.04398em;">z</span></span></span></span></span></span></span></span><span class="mclose">⌋</span></span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>y</mi><mo>=</mo><mo stretchy="false">⌊</mo><mo stretchy="false">(</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>−</mo><mfrac><mrow><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>tan</mi><mo>⁡</mo><mo stretchy="false">(</mo><mfrac><mrow><mi>π</mi><mi>l</mi><mi>a</mi><mi>t</mi></mrow><mn>180</mn></mfrac><mo stretchy="false">)</mo><mo>+</mo><mi>sec</mi><mo>⁡</mo><mo stretchy="false">(</mo><mfrac><mrow><mi>π</mi><mi>l</mi><mi>a</mi><mi>t</mi></mrow><mn>180</mn></mfrac><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><mrow><mn>2</mn><mi>π</mi></mrow></mfrac><mo stretchy="false">)</mo><mo>×</mo><msup><mn>2</mn><mi>z</mi></msup><mo stretchy="false">⌋</mo></mrow><annotation encoding="application/x-tex">y=\lfloor (\frac{1}{2}-\frac{\ln(\tan(\frac{\pi lat}{180})+\sec(\frac{\pi lat}{180}))}{2\pi})\times 2^z\rfloor
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mopen">⌊</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.3011079999999997em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6151079999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.03588em;">π</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.7350000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">ln</span><span class="mopen">(</span><span class="mop">tan</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">8</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop">sec</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">8</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7143919999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.04398em;">z</span></span></span></span></span></span></span></span><span class="mclose">⌋</span></span></span></span></span></p>
<p>这个公式可以将左上角和右下角的坐标转换成所需瓦片的左上角和右下角坐标，由此可以得到所需的所有瓦片坐标。</p>
<h3 id="获取瓦片"><a class="markdownIt-Anchor" href="#获取瓦片"></a> 获取瓦片</h3>
<p>像谷歌或者百度的瓦片服务器按照一定格式请求即可返回瓦片。谷歌和百度的格式如下，在x、y、z中分别写入瓦片的X轴坐标、Y轴坐标和瓦片层级即可：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">"google"</span>: <span class="string">"http://mt2.google.cn/vt/lyrs=&#123;style&#125;&amp;hl=zh-CN&amp;src=app&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;z=&#123;z&#125;"</span>,</span><br><span class="line"><span class="string">"amap"</span>: <span class="string">"http://wprd02.is.autonavi.com/appmaptile?style=&#123;style&#125;&amp;x=&#123;x&#125;&amp;y=&#123;y&#125;&amp;z=&#123;z&#125;"</span></span><br></pre></td></tr></table></figure>
<p>大家可以点击连接查看：<br>
<a href="http://mt2.google.cn/vt/lyrs=s&amp;x=214130&amp;y=114212&amp;z=1" target="_blank" rel="noopener">http://mt2.google.cn/vt/lyrs=s&amp;x=214130&amp;y=114212&amp;z=1</a><br>
<a href="http://wprd02.is.autonavi.com/appmaptile?style=6&amp;x=214130&amp;y=114212&amp;z=18" target="_blank" rel="noopener">http://wprd02.is.autonavi.com/appmaptile?style=6&amp;x=214130&amp;y=114212&amp;z=18</a></p>
<p>构成这样的URL后，伪装成浏览器发送请求即可，项目原作者在此基础上还做了多线程的下载来加快速度，本文不赘述。这种下载方式只适合小规模的影像，而AOI的区域往往都不大。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">HEADERS = &#123;<span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.76 Safari/537.36'</span>&#125;</span><br><span class="line">header = ur.Request(url,headers=HEADERS)</span><br><span class="line">err=<span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(err&lt;<span class="number">3</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = ur.urlopen(header).read()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        err+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"><span class="keyword">raise</span> Exception(<span class="string">"Bad network link."</span>)</span><br></pre></td></tr></table></figure>
<h3 id="拼接瓦片为影像"><a class="markdownIt-Anchor" href="#拼接瓦片为影像"></a> 拼接瓦片为影像</h3>
<p>左上角和右下角的瓦片可以得到X轴的瓦片数目<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>e</mi><mi>n</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">lenx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">x</span></span></span></span>和Y轴的瓦片数目<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>e</mi><mi>n</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">leny</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span>。使用Pillow的工具将这些瓦片按照相对位置粘贴到一起。一个瓦片占据256 * 256的大小。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 新建一个正确大小的画布</span></span><br><span class="line">outpic = pil.new(<span class="string">'RGBA'</span>, (lenx * <span class="number">256</span>, leny * <span class="number">256</span>))</span><br><span class="line"><span class="keyword">for</span> i, data <span class="keyword">in</span> enumerate(datas):</span><br><span class="line">    <span class="comment"># 获取到每一个瓦片的数据</span></span><br><span class="line">    picio = io.BytesIO(data)</span><br><span class="line">    small_pic = pil.open(picio)</span><br><span class="line">    <span class="comment"># 将数据写入画布的正确位置</span></span><br><span class="line">    y, x = i // lenx, i % lenx</span><br><span class="line">    outpic.paste(small_pic, (x * <span class="number">256</span>, y * <span class="number">256</span>))</span><br></pre></td></tr></table></figure>
<h3 id="导出影像及其信息"><a class="markdownIt-Anchor" href="#导出影像及其信息"></a> 导出影像及其信息</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">outpic.save(outfile)</span><br></pre></td></tr></table></figure>
<p>导出影像的TIF文件很简单，关键是要导出合并后图像的坐标信息TWF文件方便后续裁剪处理。TWF文件的格式如下，共六行，每行一个数：</p>
<table>
<thead>
<tr>
<th>表示字母</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>X方向上的象素分辨率</td>
</tr>
<tr>
<td>D</td>
<td>X方向的旋转系数</td>
</tr>
<tr>
<td>B</td>
<td>Y方向的旋转系数</td>
</tr>
<tr>
<td>E</td>
<td>Y方向上的象素分辨率</td>
</tr>
<tr>
<td>C</td>
<td>左上角象素中心Y坐标</td>
</tr>
<tr>
<td>F</td>
<td>左上角象素中心X坐标</td>
</tr>
</tbody>
</table>
<p>利用TWF文件中的参数可以通过<strong>像素坐标</strong><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>p</mi><mi>i</mi><mi>x</mi></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>p</mi><mi>i</mi><mi>x</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_{pix},y_{pix})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>推出经纬度坐标，公式如下：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>o</mi><mi>n</mi><mo>=</mo><mi>A</mi><mo>⋅</mo><msub><mi>x</mi><mrow><mi>p</mi><mi>i</mi><mi>x</mi></mrow></msub><mo>+</mo><mi>B</mi><mo>⋅</mo><msub><mi>y</mi><mrow><mi>p</mi><mi>i</mi><mi>x</mi></mrow></msub><mo>+</mo><mi>C</mi><mspace linebreak="newline"></mspace><mi>l</mi><mi>a</mi><mi>t</mi><mo>=</mo><mi>D</mi><mo>⋅</mo><msub><mi>x</mi><mrow><mi>p</mi><mi>i</mi><mi>x</mi></mrow></msub><mo>+</mo><mi>E</mi><mo>⋅</mo><msub><mi>y</mi><mrow><mi>p</mi><mi>i</mi><mi>x</mi></mrow></msub><mo>+</mo><mi>F</mi></mrow><annotation encoding="application/x-tex">lon=A\cdot x_{pix}+B\cdot y_{pix}+C \\
lat=D\cdot x_{pix}+E\cdot y_{pix}+F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8694379999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8694379999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8694379999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8694379999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span></span></span></span></span></p>
<p><img src="/post/def3afa0/3.png" alt="TWF公式"></p>
<p>为了获取C和F，即左上角的像素坐标，需要将瓦片坐标转回成经纬度坐标，即之前公式的反函数。左上角瓦片坐标转换后的结果即为F和C。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>o</mi><mi>n</mi><mo>=</mo><mn>360</mn><mo>⋅</mo><mfrac><mi>x</mi><msup><mn>2</mn><mi>z</mi></msup></mfrac><mo>−</mo><mn>180</mn><mspace linebreak="newline"></mspace><mi>l</mi><mi>a</mi><mi>t</mi><mo>=</mo><mi>arctan</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>sinh</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>π</mi><mo>−</mo><mn>2</mn><mi>π</mi><mo>⋅</mo><mfrac><mi>y</mi><msup><mn>2</mn><mi>z</mi></msup></mfrac><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">lon=360\cdot\frac{x}{2^z}-180 \\
lat=\arctan(\sinh(\pi-2\pi\cdot\frac{y}{2^z}))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mord">6</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.7935600000000003em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.590392em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.04398em;">z</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">8</span><span class="mord">0</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">arctan</span><span class="mopen">(</span><span class="mop">sinh</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.7935599999999998em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1075599999999999em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.590392em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.04398em;">z</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p>
<p>为了获取A和E，除了要知道左上角坐标<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mi>F</mi><mo separator="true">,</mo><mi>C</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(F, C)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mclose">)</span></span></span></span>还需要知道右下角坐标<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_{max}, y_{max})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。A和E相当于是每个像素增加多少坐标，所以要得到X轴和Y轴的像素总数，用总偏移坐标量除以像素总数即可。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><mo>=</mo><mfrac><mrow><msub><mi>x</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>−</mo><mi>F</mi></mrow><mrow><mn>256</mn><mo>⋅</mo><mi>l</mi><mi>e</mi><mi>n</mi><mi>x</mi></mrow></mfrac><mspace linebreak="newline"></mspace><mi>E</mi><mo>=</mo><mfrac><mrow><msub><mi>y</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>−</mo><mi>C</mi></mrow><mrow><mn>256</mn><mo>⋅</mo><mi>l</mi><mi>e</mi><mi>n</mi><mi>y</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">A=\frac{x_{max}-F}{256\cdot lenx} \\
E=\frac{y_{max}-C}{256\cdot leny}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord">5</span><span class="mord">6</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.24077em;vertical-align:-0.8804400000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603299999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord">5</span><span class="mord">6</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804400000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>至于D和B，由于不涉及到旋转，所以赋值为0即可。</p>
<h3 id="获取影像及其信息展示"><a class="markdownIt-Anchor" href="#获取影像及其信息展示"></a> 获取影像及其信息展示</h3>
<p><img src="/post/def3afa0/4.png" alt="获取影像及其信息展示"></p>
<h2 id="按照aoi范围裁剪影像"><a class="markdownIt-Anchor" href="#按照aoi范围裁剪影像"></a> 按照AOI范围裁剪影像</h2>
<p>这一步可以用Pillow自带的接口生成多边形mask，按照这个mask进行裁剪。但是生成多边形的接口需要得到多边形每个点的像素位置，所以先要将获取到的AOI组成的点的坐标转换成像素坐标。</p>
<h3 id="经纬坐标到像素坐标的转换"><a class="markdownIt-Anchor" href="#经纬坐标到像素坐标的转换"></a> 经纬坐标到像素坐标的转换</h3>
<p>在刚刚介绍TWF文件格式的时候可以通过像素坐标得到经纬坐标。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>o</mi><mi>n</mi><mo>=</mo><mi>A</mi><mo>⋅</mo><msub><mi>x</mi><mrow><mi>p</mi><mi>i</mi><mi>x</mi></mrow></msub><mo>+</mo><mi>B</mi><mo>⋅</mo><msub><mi>y</mi><mrow><mi>p</mi><mi>i</mi><mi>x</mi></mrow></msub><mo>+</mo><mi>C</mi><mspace linebreak="newline"></mspace><mi>l</mi><mi>a</mi><mi>t</mi><mo>=</mo><mi>D</mi><mo>⋅</mo><msub><mi>x</mi><mrow><mi>p</mi><mi>i</mi><mi>x</mi></mrow></msub><mo>+</mo><mi>E</mi><mo>⋅</mo><msub><mi>y</mi><mrow><mi>p</mi><mi>i</mi><mi>x</mi></mrow></msub><mo>+</mo><mi>F</mi></mrow><annotation encoding="application/x-tex">lon=A\cdot x_{pix}+B\cdot y_{pix}+C \\
lat=D\cdot x_{pix}+E\cdot y_{pix}+F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8694379999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8694379999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8694379999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8694379999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span></span></span></span></span></p>
<p>但是现在需要的是将经纬坐标转换成像素坐标，其实就是解上式的二元方程组：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>x</mi><mrow><mi>p</mi><mi>i</mi><mi>x</mi></mrow></msub><mo>=</mo><mfrac><mrow><mi>B</mi><mo stretchy="false">(</mo><mi>l</mi><mi>a</mi><mi>t</mi><mo>−</mo><mi>F</mi><mo stretchy="false">)</mo><mo>−</mo><mi>E</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><mi>n</mi><mo>−</mo><mi>C</mi><mo stretchy="false">)</mo></mrow><mrow><mi>D</mi><mi>B</mi><mo>−</mo><mi>A</mi><mi>E</mi></mrow></mfrac><mspace linebreak="newline"></mspace><msub><mi>y</mi><mrow><mi>p</mi><mi>i</mi><mi>x</mi></mrow></msub><mo>=</mo><mfrac><mrow><mi>A</mi><mo stretchy="false">(</mo><mi>l</mi><mi>a</mi><mi>t</mi><mo>−</mo><mi>F</mi><mo stretchy="false">)</mo><mo>−</mo><mi>D</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><mi>n</mi><mo>−</mo><mi>C</mi><mo stretchy="false">)</mo></mrow><mrow><mi>A</mi><mi>E</mi><mo>−</mo><mi>D</mi><mi>B</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">x_{pix}=\frac{B(lat-F)-E(lon-C)}{DB-AE} \\
y_{pix}=\frac{A(lat-F)-D(lon-C)}{AE-DB}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.19633em;vertical-align:-0.7693300000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.19633em;vertical-align:-0.7693300000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<h3 id="裁剪影像"><a class="markdownIt-Anchor" href="#裁剪影像"></a> 裁剪影像</h3>
<p>将AOI的经纬坐标通过上面的转换变成像素坐标后记为polygon。使用ImageDraw可以绘制一个多边形mask，这个mask是二维的，表示每一个像素的状态，在多边形内则像素状态为1，反之为0。只需要将三通道的每一个像素分别乘上mask对应的状态即可完成裁剪。</p>
<p>此处的裁剪方法是裁剪掉的部分像素为(0,0,0)。这里可以针对像素坐标再做一次最小外接矩形，按这个矩形裁剪一次。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># read image as RGB and add alpha (transparency)</span></span><br><span class="line">im = Image.open(tif_file).convert(<span class="string">"RGB"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># convert to numpy (for convenience)</span></span><br><span class="line">imArray = numpy.asarray(im)</span><br><span class="line"></span><br><span class="line"><span class="comment"># create mask</span></span><br><span class="line">maskIm = Image.new(<span class="string">'L'</span>, (imArray.shape[<span class="number">1</span>], imArray.shape[<span class="number">0</span>]), <span class="number">0</span>)</span><br><span class="line">ImageDraw.Draw(maskIm).polygon(polygon, outline=<span class="number">1</span>, fill=<span class="number">1</span>)</span><br><span class="line">mask = numpy.array(maskIm)</span><br><span class="line"></span><br><span class="line"><span class="comment"># assemble new image (uint8: 0-255)</span></span><br><span class="line">newImArray = numpy.empty(imArray.shape, dtype=<span class="string">'uint8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># colors (three first columns, RGB)</span></span><br><span class="line">newImArray[:, :, :<span class="number">3</span>] = imArray[:, :, :<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># crop</span></span><br><span class="line">newImArray[:, :, <span class="number">0</span>] *= mask</span><br><span class="line">newImArray[:, :, <span class="number">1</span>] *= mask</span><br><span class="line">newImArray[:, :, <span class="number">2</span>] *= mask</span><br><span class="line">newImArray = newImArray[min_y:max_y, min_x:max_x]</span><br><span class="line"></span><br><span class="line"><span class="comment"># back to Image from numpy</span></span><br><span class="line">newIm = Image.fromarray(newImArray, <span class="string">"RGB"</span>)</span><br><span class="line">newIm.save(to)</span><br></pre></td></tr></table></figure>
<h3 id="裁剪结果展示"><a class="markdownIt-Anchor" href="#裁剪结果展示"></a> 裁剪结果展示</h3>
<p><img src="/post/def3afa0/5.png" alt="裁剪结果"></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Siang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://psiang.github.io/post/def3afa0.html">https://psiang.github.io/post/def3afa0.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://psiang.github.io" target="_blank">Siang的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%81%A5%E6%84%9F/">遥感</a><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/">数据处理</a><a class="post-meta__tags" href="/tags/AOI/">AOI</a><a class="post-meta__tags" href="/tags/OSM/">OSM</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/24/wz4Fho9QcKuSiqI.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/post/6682fb6a.html"><img class="next_cover" src="https://i.loli.net/2020/05/24/O3RIV5NAez2Zqip.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">新深度卷积网络一览（二）</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Siang</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a hrefmy <a href"https://psiang.github.io/">blog</a>!</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script>$(function () {
  $('span.katex-display').wrap('<div class="katex-wrap"></div>')
})</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script></body></html>